#!/bin/bash
#store="/persistent/TOOD2"
#states=$store"/states"
#overlayChanges="/overlay/TOOD2_20151108/overlay"
#snapshotDateTime=`date +%Y%m%d_%H%M`

#Debug
#rm -Rf $states/20151109*
#ls $states
#echo "Try rm $snapshotDateTime"
dstForMove=$states"/"$preparedAt
dst=$states"/"$snapTo
dstChanges=$changes"/"$snapTo
last=$states"/last"
if [ -d "$dstForMove" ]; then
  echo "Move folder $dstForMove to $dst"
  mv "$dstForMove" "$dst"
else
  rm -Rf "$dst"
  echo "cp last to $snapTo"
  cp -Ralp "$last" "$dst"
fi

#На всякий случай проверям есть ли папка для изменений
if [ -d "$dstChanges" ]; then
  #Удаляем
  rm -Rf "$dstChanges"
fi
#Изменения Подготовительного снапшота не нужны
if [ -d "$changes"/"$preparedAt" ]; then
  rm -Rf "$changes"/"$preparedAt"
fi

if [ $onlyPrepare -eq 0 ]; then
  mkdir -p "$dstChanges"

  echo ""
  echo "Enumerate changes:"
  if [ ! -d "$overlayChanges" ]; then
    echo "!!Dir does not exists $overlayChanges"
    return 2
  fi
  cd "$overlayChanges"

  find -print0 | while read -r -d $'\0' FILE; do
    F=`echo "$FILE" | sed 's/^\.\///'`
    DIR=`dirname "$F"`
    #echo "Item:$F"

    if [ -c "$FILE" ]; then
      echo "Remove file "$F
      rm -fvR "$last/$F"
      rm -fvR "$dst/$F"
    
      #Изменения
      rm -Rf "$dstChanges/$F"
      rsync -a --numeric-ids --acls --xattrs "$overlayChanges/$F" "$dstChanges/$F"
    
      #Не убираем с оверлэй слоя
      #rm -fv "$overlayChanges/$F"
    elif [ -d "$FILE" ]; then
      echo "Dir $F"
      if [ -f "$dst/$F" ]; then
        #Если раньше был файл, а теперь каталог
        rm -fv "$dst/$F"
        rm -fv "$last/$F"
        mkdir -p "$dst/$DIR"
        mkdir -p "$last/$DIR"
      fi
      mkdir -p "$dstChanges/$DIR"
      #Dir with attributes
      rsync -ad --numeric-ids --acls --xattrs --no-recursive --exclude='*' "$overlayChanges/$F/" "$dst/$F"
      incErrCnt
    
      #Атрибуты для папки в last
      rsync -ad --numeric-ids --acls --xattrs --no-recursive --exclude='*' "$overlayChanges/$F/" "$last/$F"
      incErrCnt
    
      #Аттрибуты для папки в changes
      rsync -ad --numeric-ids --acls --xattrs --no-recursive --exclude='*' "$overlayChanges/$F/" "$dstChanges/$F"
      incErrCnt
    elif [ -f "$FILE" ]; then
      if [ -d "$dst/$F" ]; then
        #Если раньше был каталог, а сейчас файл
        rm -Rf "$dst/$F"
        rm -Rf "$last/$F"
      else
        #Принудительно удалим, чтобы создался новый inode
        rm -f "$dst/$F"
        rm -f "$last/$F"
      fi

      echo "Rsync file $F"
      mkdir -p "$dst/$DIR"
      rsync -a --numeric-ids --acls --xattrs "$overlayChanges/$F" "$dst/$F"
      incErrCnt
      mkdir -p "$last/$DIR"
      ln -fv "$dst/$F" "$last/$F"
      incErrCnt

      mkdir -p "$dstChanges/$DIR"
      ln -fv "$dst/$F" "$dstChanges/$F"
      incErrCnt
    fi
  done
echo "Finish enum"
echo ""
#onlyPrepare=0
fi

